#!/usr/bin/ruby

# Panoptimon - The All-Seeing System Monitor Daemon

# copyright 2012 Eric L. Wilhelm

require 'panoptimon'

require 'ostruct'
require 'json'
require 'pathname'

require 'rubygems'
require 'daemons'
require 'eventmachine'

opts = Panoptimon.load_options(ARGV) or exit

# XXX needs a real test
puts "options: ", JSON.pretty_generate(opts.marshal_dump) if opts.debug

if opts.lists

  opts.lists.uniq.sort.each { |list|
    dirlist = ->(x) {
      Pathname.new(x).entries.find_all {|f| f.to_s =~ /\.json$/i}
    }
    does = {
      collectors: ->() { dirlist.call(opts.collectors_dir) },
      plugins:    ->() { dirlist.call(opts.plugins_dir) },
      roles:      ->() { raise "roles list not implemented" },
    }
    puts does[list].call.unshift("#{list}:").join("\n  ");
  }

  exit
end

# TODO load plugins before daemonize - fatal on errors

if opts.daemonize
  # TODO could possibly use webrick::daemon.start or process.daemon,
  # but this has support for redirecting io to logfiles... worth it?
  Daemons.daemonize
end

# TODO load collectors after daemonize - skip + complain

# vim:ts=2:sw=2:et:sta
