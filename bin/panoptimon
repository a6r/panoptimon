#!/usr/bin/ruby

# Panoptimon - The All-Seeing System Monitor Daemon

# copyright 2012 Eric L. Wilhelm

require 'optparse'
require 'ostruct'
require 'json'

require 'rubygems'
require 'daemons'
require 'eventmachine'

def load_options
  defaults = {
    :daemonize      => true,
    :config_dir     => '/etc/panoptimon/',
    :config_file    => '/etc/panoptimon/.panoptimon',
    :collectors_dir => '%/collectors',
    :plugins_dir    => '%/plugins',
    :collector_timeout  => 120,
    :collector_interval => 60,
  }

  options = {:config_file => '-'} # XXX

  config = defaults.merge!(
    options[:config_file] == '-' ? {} : JSON.parse(
      File.read(options[:config_file] || defaults[:config_file])
    )
  ).merge!(options);

  #config[:config_dir].sub!(/\/*$/, '/');
  for d in [:collectors_dir, :plugins_dir]
    config[d] = File.join(config[:config_dir], config[d]) \
      if config[d].sub!(/^%\//, '')
  end

  puts config

  return OpenStruct.new(config).freeze
end

load_options()

# vim:ts=2:sw=2:et:sta
